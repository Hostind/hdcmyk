<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Performance Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
    </style>
</head>
<body>
    <h1>Performance Optimization Test</h1>
    <div id="test-results"></div>

    <script src="color-science.js"></script>
    <script>
        function addTestResult(name, success, message) {
            const div = document.createElement('div');
            div.className = `test-result ${success ? 'success' : 'error'}`;
            div.innerHTML = `<strong>${name}:</strong> ${message}`;
            document.getElementById('test-results').appendChild(div);
        }

        // Test 1: Color conversion caching
        try {
            const start = performance.now();
            
            // First conversion
            const rgb1 = window.colorScience.cmykToRgb(50, 30, 80, 10);
            const time1 = performance.now() - start;
            
            // Second identical conversion (should be faster due to caching)
            const start2 = performance.now();
            const rgb2 = window.colorScience.cmykToRgb(50, 30, 80, 10);
            const time2 = performance.now() - start2;
            
            const identical = JSON.stringify(rgb1) === JSON.stringify(rgb2);
            addTestResult('Color Conversion Caching', identical, 
                `First: ${time1.toFixed(2)}ms, Second: ${time2.toFixed(2)}ms, Results identical: ${identical}`);
        } catch (error) {
            addTestResult('Color Conversion Caching', false, error.message);
        }

        // Test 2: Delta E error handling
        try {
            // Valid calculation
            const validResult = window.colorScience.performDeltaEAnalysis(
                { l: 50, a: 10, b: 20 },
                { l: 52, a: 12, b: 18 }
            );
            
            const hasValidResult = validResult.deltaE !== null && !validResult.error;
            addTestResult('Valid Delta E Calculation', hasValidResult, 
                `Delta E: ${validResult.deltaE}, Performance: ${validResult.performanceMs?.toFixed(2)}ms`);
        } catch (error) {
            addTestResult('Valid Delta E Calculation', false, error.message);
        }

        // Test 3: Error handling for invalid input
        try {
            const invalidResult = window.colorScience.performDeltaEAnalysis(
                null,
                { l: 52, a: 12, b: 18 }
            );
            
            const hasError = invalidResult.error !== undefined;
            addTestResult('Invalid Input Error Handling', hasError, 
                `Error properly caught: ${invalidResult.error}`);
        } catch (error) {
            addTestResult('Invalid Input Error Handling', false, error.message);
        }

        // Test 4: Identical colors optimization
        try {
            const identicalResult = window.colorScience.performDeltaEAnalysis(
                { l: 50, a: 10, b: 20 },
                { l: 50, a: 10, b: 20 }
            );
            
            const isOptimized = identicalResult.optimized === true && identicalResult.deltaE === 0;
            addTestResult('Identical Colors Optimization', isOptimized, 
                `Delta E: ${identicalResult.deltaE}, Optimized: ${identicalResult.optimized}, Performance: ${identicalResult.performanceMs?.toFixed(2)}ms`);
        } catch (error) {
            addTestResult('Identical Colors Optimization', false, error.message);
        }

        // Test 5: Cache statistics
        try {
            const stats = window.colorScience.getColorConversionCacheStats();
            const hasStats = stats && typeof stats.size === 'number';
            addTestResult('Cache Statistics', hasStats, 
                `Cache size: ${stats.size}, Max size: ${stats.maxSize}`);
        } catch (error) {
            addTestResult('Cache Statistics', false, error.message);
        }

        console.log('Performance optimization tests completed');
    </script>
</body>
</html>