<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Test - LAB Color Calculator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .pass { background: #d4edda; color: #155724; }
        .fail { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .online { background: #28a745; }
        .offline { background: #dc3545; }
    </style>
</head>
<body>
    <h1>PWA Functionality Test</h1>
    <p>This page tests the Progressive Web App capabilities of the LAB Color Calculator.</p>
    
    <div class="test-section">
        <h2>Connection Status</h2>
        <div id="connection-status">
            <span class="status-indicator" id="status-dot"></span>
            <span id="status-text">Checking...</span>
        </div>
        <button onclick="testOfflineMode()">Test Offline Mode</button>
    </div>
    
    <div class="test-section">
        <h2>Service Worker Status</h2>
        <div id="sw-status" class="test-result info">Checking service worker...</div>
        <button onclick="testServiceWorker()">Test Service Worker</button>
        <button onclick="updateServiceWorker()">Force Update</button>
    </div>
    
    <div class="test-section">
        <h2>Manifest and Installation</h2>
        <div id="manifest-status" class="test-result info">Checking manifest...</div>
        <button onclick="testManifest()">Test Manifest</button>
        <button onclick="triggerInstallPrompt()">Trigger Install</button>
    </div>
    
    <div class="test-section">
        <h2>Offline Storage</h2>
        <div id="storage-status" class="test-result info">Checking storage...</div>
        <button onclick="testOfflineStorage()">Test Offline Storage</button>
        <button onclick="clearOfflineData()">Clear Offline Data</button>
    </div>
    
    <div class="test-section">
        <h2>Cache Status</h2>
        <div id="cache-status" class="test-result info">Checking cache...</div>
        <button onclick="testCache()">Test Cache</button>
        <button onclick="clearCache()">Clear Cache</button>
    </div>
    
    <div class="test-section">
        <h2>Core Functionality Offline</h2>
        <div id="offline-calc-status" class="test-result info">Ready to test...</div>
        <button onclick="testOfflineCalculations()">Test Offline Calculations</button>
    </div>
    
    <div class="test-section">
        <h2>Test Results Summary</h2>
        <div id="test-summary"></div>
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="exportTestResults()">Export Results</button>
    </div>
    
    <script>
        let testResults = {};
        
        // Update connection status
        function updateConnectionStatus() {
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            
            if (navigator.onLine) {
                statusDot.className = 'status-indicator online';
                statusText.textContent = 'Online';
            } else {
                statusDot.className = 'status-indicator offline';
                statusText.textContent = 'Offline';
            }
        }
        
        // Test service worker
        async function testServiceWorker() {
            const statusDiv = document.getElementById('sw-status');
            
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    if (registration) {
                        statusDiv.className = 'test-result pass';
                        statusDiv.textContent = `✓ Service Worker registered (scope: ${registration.scope})`;
                        testResults.serviceWorker = 'pass';
                    } else {
                        statusDiv.className = 'test-result fail';
                        statusDiv.textContent = '✗ Service Worker not registered';
                        testResults.serviceWorker = 'fail';
                    }
                } catch (error) {
                    statusDiv.className = 'test-result fail';
                    statusDiv.textContent = `✗ Service Worker error: ${error.message}`;
                    testResults.serviceWorker = 'fail';
                }
            } else {
                statusDiv.className = 'test-result fail';
                statusDiv.textContent = '✗ Service Worker not supported';
                testResults.serviceWorker = 'fail';
            }
        }
        
        // Test manifest
        async function testManifest() {
            const statusDiv = document.getElementById('manifest-status');
            
            try {
                const response = await fetch('/manifest.json');
                if (response.ok) {
                    const manifest = await response.json();
                    statusDiv.className = 'test-result pass';
                    statusDiv.textContent = `✓ Manifest loaded: ${manifest.name}`;
                    testResults.manifest = 'pass';
                } else {
                    statusDiv.className = 'test-result fail';
                    statusDiv.textContent = '✗ Manifest not found';
                    testResults.manifest = 'fail';
                }
            } catch (error) {
                statusDiv.className = 'test-result fail';
                statusDiv.textContent = `✗ Manifest error: ${error.message}`;
                testResults.manifest = 'fail';
            }
        }
        
        // Test offline storage
        function testOfflineStorage() {
            const statusDiv = document.getElementById('storage-status');
            
            try {
                // Test localStorage
                const testKey = 'pwa-test-' + Date.now();
                const testData = { test: true, timestamp: Date.now() };
                
                localStorage.setItem(testKey, JSON.stringify(testData));
                const retrieved = JSON.parse(localStorage.getItem(testKey));
                localStorage.removeItem(testKey);
                
                if (retrieved && retrieved.test === true) {
                    statusDiv.className = 'test-result pass';
                    statusDiv.textContent = '✓ Offline storage working';
                    testResults.offlineStorage = 'pass';
                } else {
                    statusDiv.className = 'test-result fail';
                    statusDiv.textContent = '✗ Offline storage failed';
                    testResults.offlineStorage = 'fail';
                }
                
                // Test storage quota
                if ('storage' in navigator && 'estimate' in navigator.storage) {
                    navigator.storage.estimate().then(estimate => {
                        const usage = (estimate.usage / 1024 / 1024).toFixed(2);
                        const quota = (estimate.quota / 1024 / 1024).toFixed(2);
                        statusDiv.textContent += ` (${usage}MB / ${quota}MB used)`;
                    });
                }
                
            } catch (error) {
                statusDiv.className = 'test-result fail';
                statusDiv.textContent = `✗ Storage error: ${error.message}`;
                testResults.offlineStorage = 'fail';
            }
        }
        
        // Test cache
        async function testCache() {
            const statusDiv = document.getElementById('cache-status');
            
            if ('caches' in window) {
                try {
                    const cacheNames = await caches.keys();
                    if (cacheNames.length > 0) {
                        statusDiv.className = 'test-result pass';
                        statusDiv.textContent = `✓ Cache active: ${cacheNames.join(', ')}`;
                        testResults.cache = 'pass';
                    } else {
                        statusDiv.className = 'test-result info';
                        statusDiv.textContent = 'ℹ No caches found (may be normal on first load)';
                        testResults.cache = 'info';
                    }
                } catch (error) {
                    statusDiv.className = 'test-result fail';
                    statusDiv.textContent = `✗ Cache error: ${error.message}`;
                    testResults.cache = 'fail';
                }
            } else {
                statusDiv.className = 'test-result fail';
                statusDiv.textContent = '✗ Cache API not supported';
                testResults.cache = 'fail';
            }
        }
        
        // Test offline calculations
        function testOfflineCalculations() {
            const statusDiv = document.getElementById('offline-calc-status');
            
            try {
                // Test basic color science functions
                const testCmyk = { c: 50, m: 30, y: 80, k: 10 };
                const testLab1 = { l: 60, a: 20, b: 40 };
                const testLab2 = { l: 55, a: 25, b: 35 };
                
                // These would normally come from the color science module
                // For testing, we'll simulate basic calculations
                const deltaE = Math.sqrt(
                    Math.pow(testLab1.l - testLab2.l, 2) +
                    Math.pow(testLab1.a - testLab2.a, 2) +
                    Math.pow(testLab1.b - testLab2.b, 2)
                );
                
                if (deltaE > 0) {
                    statusDiv.className = 'test-result pass';
                    statusDiv.textContent = `✓ Offline calculations working (ΔE: ${deltaE.toFixed(2)})`;
                    testResults.offlineCalculations = 'pass';
                } else {
                    statusDiv.className = 'test-result fail';
                    statusDiv.textContent = '✗ Offline calculations failed';
                    testResults.offlineCalculations = 'fail';
                }
                
            } catch (error) {
                statusDiv.className = 'test-result fail';
                statusDiv.textContent = `✗ Calculation error: ${error.message}`;
                testResults.offlineCalculations = 'fail';
            }
        }
        
        // Test offline mode simulation
        function testOfflineMode() {
            const originalOnLine = navigator.onLine;
            
            // Simulate offline
            Object.defineProperty(navigator, 'onLine', {
                writable: true,
                value: false
            });
            
            updateConnectionStatus();
            
            setTimeout(() => {
                // Restore online
                Object.defineProperty(navigator, 'onLine', {
                    writable: true,
                    value: originalOnLine
                });
                updateConnectionStatus();
            }, 3000);
        }
        
        // Update service worker
        async function updateServiceWorker() {
            if ('serviceWorker' in navigator) {
                const registration = await navigator.serviceWorker.getRegistration();
                if (registration) {
                    registration.update();
                    alert('Service worker update triggered');
                }
            }
        }
        
        // Trigger install prompt
        function triggerInstallPrompt() {
            // This would normally use the deferred prompt
            alert('Install prompt would appear here (if supported by browser)');
        }
        
        // Clear offline data
        function clearOfflineData() {
            try {
                localStorage.removeItem('offlineCalculations');
                localStorage.removeItem('cachedCalculationFunctions');
                alert('Offline data cleared');
            } catch (error) {
                alert('Error clearing offline data: ' + error.message);
            }
        }
        
        // Clear cache
        async function clearCache() {
            if ('caches' in window) {
                const cacheNames = await caches.keys();
                await Promise.all(cacheNames.map(name => caches.delete(name)));
                alert('Cache cleared');
            }
        }
        
        // Run all tests
        async function runAllTests() {
            await testServiceWorker();
            await testManifest();
            testOfflineStorage();
            await testCache();
            testOfflineCalculations();
            
            updateTestSummary();
        }
        
        // Update test summary
        function updateTestSummary() {
            const summaryDiv = document.getElementById('test-summary');
            const results = Object.entries(testResults);
            
            const passed = results.filter(([_, result]) => result === 'pass').length;
            const failed = results.filter(([_, result]) => result === 'fail').length;
            const info = results.filter(([_, result]) => result === 'info').length;
            
            summaryDiv.innerHTML = `
                <div class="test-result ${failed === 0 ? 'pass' : 'info'}">
                    Tests: ${passed} passed, ${failed} failed, ${info} info
                </div>
                <div style="margin-top: 10px;">
                    ${results.map(([test, result]) => 
                        `<div class="test-result ${result}">${test}: ${result}</div>`
                    ).join('')}
                </div>
            `;
        }
        
        // Export test results
        function exportTestResults() {
            const results = {
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                online: navigator.onLine,
                serviceWorkerSupported: 'serviceWorker' in navigator,
                cacheSupported: 'caches' in window,
                storageSupported: 'localStorage' in window,
                testResults: testResults
            };
            
            const dataStr = JSON.stringify(results, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `pwa-test-results-${Date.now()}.json`;
            link.click();
        }
        
        // Initialize
        window.addEventListener('load', () => {
            updateConnectionStatus();
            
            // Auto-run basic tests
            setTimeout(() => {
                testServiceWorker();
                testManifest();
            }, 1000);
        });
        
        // Listen for online/offline events
        window.addEventListener('online', updateConnectionStatus);
        window.addEventListener('offline', updateConnectionStatus);
    </script>
</body>
</html>