<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=3.0">
    <title>LAB Color Matching Calculator</title>
    <meta name="description" content="Professional CMYK to LAB color difference calculator for printing industry">
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="LAB Calculator">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="src/assets/icons/icon.svg">
    <link rel="apple-touch-icon" href="src/assets/icons/icon.svg">
    <link rel="stylesheet" href="src/css/styles.css">
</head>
<body>
    <!-- Enhanced Sticky Status Bar -->
    <div class="status-bar" id="status-bar">
        <div class="status-bar-content">
            <div class="status-info">
                <span class="status-label">Status:</span>
                <span class="status-value" id="status-value">Ready</span>
            </div>
            <div class="delta-info">
                <span class="delta-label">Î”E*ab:</span>
                <span class="delta-value" id="status-delta-value">--</span>
            </div>
            <div class="quick-actions-bar">
                <button class="status-action-btn" id="status-calculate-btn" title="Calculate color difference">
                    Calculate
                </button>
                <button class="status-action-btn" id="status-reset-btn" title="Reset all inputs">
                    Reset
                </button>
                <button class="status-action-btn" id="status-export-btn" title="Export results" disabled>
                    Export
                </button>
            </div>
        </div>
    </div>

    <div class="calculator-container">
        <header class="app-header">
            <div class="header-content">
                <div class="header-text">
                    <h1>LAB Color Matching Calculator</h1>
                    <p class="subtitle">Professional CMYK-to-LAB Visual Color Difference Calculator</p>
                </div>
                <div class="header-controls">
                    <button class="theme-toggle" id="theme-toggle" title="Toggle dark/light mode">
                        <span class="theme-icon">ðŸŒ™</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Horizontal Equation Layout -->
        <div class="equation-container">
            <!-- Target Color Section -->
            <section class="color-section" id="target-section">
                <h2 class="tooltip-enhanced" data-tooltip="Enter the desired color values for your target.&#10;Supports both CMYK ink percentages and LAB measurements.&#10;Use presets for common colors or input custom values.&#10;&#10;â€¢ CMYK: Cyan, Magenta, Yellow, Black percentages (0-100%)&#10;â€¢ LAB: L* (lightness 0-100), a* (green-red -128 to +127), b* (blue-yellow -128 to +127)&#10;&#10;Real-time color swatch shows approximate appearance.">Target Color</h2>
                <div class="color-display">
                    <div class="color-swatch" id="target-swatch" aria-label="Target color preview"></div>
                </div>
                
                <!-- Preset Colors and Quick Actions -->
                <div class="preset-controls">
                    <div class="preset-dropdown-container">
                        <label for="target-preset-select">Preset Colors:</label>
                        <select id="target-preset-select" class="preset-select">
                            <option value="">Select a preset color...</option>
                        </select>
                    </div>
                    <div class="quick-actions">
                        <button type="button" class="quick-action-btn" id="target-clear-btn" title="Clear all target color inputs">Clear</button>
                        <button type="button" class="quick-action-btn" id="target-copy-btn" title="Copy target CMYK values to clipboard">Copy CMYK</button>
                    </div>
                </div>
                
                <div class="input-groups">
                    <div class="input-group">
                        <label class="group-label">CMYK Values
                            <div class="inline-help">
                                <div class="help-icon tooltip-trigger">
                                    <div class="tooltip-content printing-tooltip">
                                        <div class="tooltip-title">CMYK Input Guidelines</div>
                                        <div class="tooltip-description">Enter ink percentages (0-100%) for Cyan, Magenta, Yellow, and Black (Key) process colors.</div>
                                        <div class="tooltip-tip">Professional tip: Total ink coverage should typically not exceed 280-320% depending on your press and substrate.</div>
                                    </div>
                                </div>
                            </div>
                        </label>
                        <div class="input-row">
                            <div class="input-field">
                                <label for="target-c">C%</label>
                                <input type="number" id="target-c" placeholder="0" min="0" max="100" step="0.1">
                            </div>
                            <div class="input-field">
                                <label for="target-m">M%</label>
                                <input type="number" id="target-m" placeholder="0" min="0" max="100" step="0.1">
                            </div>
                            <div class="input-field">
                                <label for="target-y">Y%</label>
                                <input type="number" id="target-y" placeholder="0" min="0" max="100" step="0.1">
                            </div>
                            <div class="input-field">
                                <label for="target-k">K%</label>
                                <input type="number" id="target-k" placeholder="0" min="0" max="100" step="0.1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="group-label">LAB Values</label>
                        <div class="input-row">
                            <div class="input-field">
                                <label for="target-l">L*</label>
                                <input type="number" id="target-l" placeholder="50" min="0" max="100" step="0.01">
                            </div>
                            <div class="input-field">
                                <label for="target-a">a*</label>
                                <input type="number" id="target-a" placeholder="0" min="-128" max="127" step="0.01">
                            </div>
                            <div class="input-field">
                                <label for="target-b">b*</label>
                                <input type="number" id="target-b" placeholder="0" min="-128" max="127" step="0.01">
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Minus Symbol -->
            <div class="color-equation-symbol" style="font-size: 3rem; color: var(--text-secondary); align-self: center;">-</div>

            <!-- Sample Color Section -->
            <section class="color-section" id="sample-section">
                <h2 class="tooltip-enhanced" data-tooltip="Enter the measured color values from your sample.&#10;Compare against target to calculate color difference.&#10;Real-time swatch preview shows approximate color.&#10;&#10;â€¢ Use spectrophotometer readings for LAB values&#10;â€¢ Use densitometer readings for CMYK values&#10;â€¢ Preset colors available for quick testing&#10;&#10;Sample color will be compared against target for Delta E calculation.">Sample Color</h2>
                <div class="color-display">
                    <div class="color-swatch" id="sample-swatch" aria-label="Sample color preview"></div>
                </div>
                
                <!-- Preset Colors and Quick Actions -->
                <div class="preset-controls">
                    <div class="preset-dropdown-container">
                        <label for="sample-preset-select">Preset Colors:</label>
                        <select id="sample-preset-select" class="preset-select">
                            <option value="">Select a preset color...</option>
                        </select>
                    </div>
                    <div class="quick-actions">
                        <button type="button" class="quick-action-btn" id="sample-clear-btn" title="Clear all sample color inputs">Clear</button>
                        <button type="button" class="quick-action-btn" id="sample-copy-btn" title="Copy sample CMYK values to clipboard">Copy CMYK</button>
                    </div>
                </div>
                
                <div class="input-groups">
                    <div class="input-group">
                        <label class="group-label">CMYK Values</label>
                        <div class="input-row">
                            <div class="input-field">
                                <label for="sample-c">C%</label>
                                <input type="number" id="sample-c" placeholder="0" min="0" max="100" step="0.1">
                            </div>
                            <div class="input-field">
                                <label for="sample-m">M%</label>
                                <input type="number" id="sample-m" placeholder="0" min="0" max="100" step="0.1">
                            </div>
                            <div class="input-field">
                                <label for="sample-y">Y%</label>
                                <input type="number" id="sample-y" placeholder="0" min="0" max="100" step="0.1">
                            </div>
                            <div class="input-field">
                                <label for="sample-k">K%</label>
                                <input type="number" id="sample-k" placeholder="0" min="0" max="100" step="0.1">
                            </div>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <label class="group-label">LAB Values</label>
                        <div class="input-row">
                            <div class="input-field">
                                <label for="sample-l">L*</label>
                                <input type="number" id="sample-l" placeholder="50" min="0" max="100" step="0.01">
                            </div>
                            <div class="input-field">
                                <label for="sample-a">a*</label>
                                <input type="number" id="sample-a" placeholder="0" min="-128" max="127" step="0.01">
                            </div>
                            <div class="input-field">
                                <label for="sample-b">b*</label>
                                <input type="number" id="sample-b" placeholder="0" min="-128" max="127" step="0.01">
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Equals Symbol -->
            <div class="color-equation-symbol" style="font-size: 3rem; color: var(--text-secondary); align-self: center;">=</div>

            <!-- Delta Results Section -->
            <section class="delta-section" id="delta-section">
                <h2 class="tooltip-enhanced" data-tooltip="Displays calculated color difference results.&#10;Î”E*ab shows total color difference between target and sample.&#10;Component deltas show individual L*, a*, b* differences.&#10;&#10;â€¢ Î”E*ab < 1.0: Excellent match (not perceptible)&#10;â€¢ Î”E*ab 1.0-2.0: Good match (barely perceptible)&#10;â€¢ Î”E*ab 2.0-4.0: Acceptable match (noticeable)&#10;â€¢ Î”E*ab > 4.0: Poor match (clearly visible)" tabindex="0">Delta</h2>
                <div class="color-display">
                    <div class="delta-indicator" id="delta-indicator">
                        <span class="delta-symbol">Î”</span>
                    </div>
                </div>
                
                <div class="delta-values" id="delta-values">
                    <div class="delta-item">
                        <label>Î”L*</label>
                        <span id="delta-l">--</span>
                    </div>
                    <div class="delta-item">
                        <label>Î”a*</label>
                        <span id="delta-a">--</span>
                    </div>
                    <div class="delta-item">
                        <label>Î”b*</label>
                        <span id="delta-b">--</span>
                    </div>
                    <div class="delta-item">
                        <label>Î”C*</label>
                        <span id="delta-c">--</span>
                    </div>
                    <div class="delta-item">
                        <label>Î”h</label>
                        <span id="delta-h">--</span>
                    </div>
                </div>
            </section>
        </div>
        <!-- End equation container -->

        <!-- Calculate Button -->
        <div class="calculate-section">
            <div class="calculate-controls">
                <button id="calculate-btn" class="calculate-button btn-outlined gold-premium">
                    Calculate Color Difference
                </button>
                <button id="reset-all-btn" class="reset-button" title="Clear all inputs and reset the calculator">
                    Reset All
                </button>
                <button id="workflow-toggle-btn" class="workflow-toggle-btn" title="Show step-by-step calculation process">
                    Show Process
                </button>
                <button id="help-toggle-btn" class="help-toggle" title="Show professional guidance and tips">
                    Help Guide
                </button>
            </div>
        </div>

        <!-- Professional Help Panel -->
        <div class="help-panel" id="professional-help-panel">
            <h4>Professional Color Matching Guide</h4>
            <p><strong>Target Color:</strong> Enter the color you want to achieve. Use either CMYK ink percentages or LAB device-independent values.</p>
            <p><strong>Sample Color:</strong> Enter the color you actually measured or produced. Compare this against your target to see the difference.</p>
            
            <div class="help-example">
                Example: Target C:50 M:30 Y:0 K:10 vs Sample C:52 M:28 Y:2 K:12
                Result: Î”E = 2.4 (Acceptable for commercial printing)
            </div>
            
            <p><strong>Delta E Interpretation:</strong></p>
            <ul style="color: var(--text-secondary); margin-left: 1.5rem;">
                <li>Î”E â‰¤ 1.0: Perfect match (not detectable by human eye)</li>
                <li>Î”E 1.0-2.0: Very good match (slight difference)</li>
                <li>Î”E 2.0-3.5: Good match (acceptable for most commercial work)</li>
                <li>Î”E > 3.5: Poor match (requires adjustment)</li>
            </ul>
            
            <p><strong>Professional Tips:</strong></p>
            <ul style="color: var(--text-secondary); margin-left: 1.5rem;">
                <li>Use spectrophotometer measurements for LAB values when possible</li>
                <li>Consider substrate and lighting conditions</li>
                <li>Total ink coverage (TAC) should typically stay below 300%</li>
                <li>Use the step-by-step process view for complex calculations</li>
            </ul>
        </div>

        <!-- Results Section -->
        <section class="results-section" id="results-section">
            <div class="total-delta-e">
                <h3>Total Color Difference</h3>
                <div class="delta-e-value important-value" id="delta-e-value">
                    <span class="delta-e-number value">--</span>
                    <span class="delta-e-label">Î”E*ab</span>
                </div>
                <div class="tolerance-zone" id="tolerance-zone"></div>
            </div>

            <div class="suggestions-container" id="suggestions-container">
                <h3>Suggested CMYK Adjustments to Reach Target</h3>
                <div class="suggestions-list" id="suggestions-list">
                    <!-- Suggestions will be populated by JavaScript -->
                </div>
            </div>

            <!-- G7 Analysis Section -->
            <div class="g7-analysis-container premium-feature" id="g7-analysis-container" style="display: none;">
                <h3 class="gold-accent">G7 Gray Balance Analysis <span class="premium-badge">Premium</span></h3>
                <div class="g7-analysis-content">
                    <div class="g7-compliance-status" id="g7-compliance-status">
                        <div class="compliance-indicator" id="compliance-indicator">
                            <span class="compliance-icon">âšª</span>
                            <span class="compliance-text">Analyzing...</span>
                        </div>
                        <div class="compliance-details" id="compliance-details">
                            <span class="gray-level">Gray Level: --</span>
                            <span class="deviation">Total Deviation: --</span>
                        </div>
                    </div>
                    
                    <div class="g7-recommendations" id="g7-recommendations">
                        <h4>G7 Recommendations</h4>
                        <div class="g7-recommendations-list" id="g7-recommendations-list">
                            <!-- G7 recommendations will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="g7-controls">
                        <label class="g7-toggle">
                            <input type="checkbox" id="enable-g7-analysis" checked>
                            <span class="toggle-text">Enable G7 Analysis</span>
                        </label>
                        <label class="g7-toggle">
                            <input type="checkbox" id="prioritize-g7-suggestions">
                            <span class="toggle-text">Prioritize G7 Suggestions</span>
                        </label>
                    </div>
                </div>
            </div>
        </section>

        <!-- History and Export Section -->
        <section class="tools-section" id="tools-section">
            <div class="history-panel">
                <h3>Recent Comparisons</h3>
                <div class="history-list" id="history-list">
                    <!-- History items will be populated by JavaScript -->
                </div>
                <button class="clear-history-btn" id="clear-history-btn">Clear History</button>
            </div>
            
            <div class="export-panel premium">
                <h3 class="gold-accent">Export Results</h3>
                <div class="export-buttons">
                    <button class="export-btn btn-outlined gold" id="export-csv-btn">Export CSV</button>
                    <button class="export-btn btn-outlined gold-premium" id="export-pdf-btn">Export PDF</button>
                </div>
            </div>
            
            <div class="testing-panel">
                <h3>Testing & Validation</h3>
                <div class="testing-buttons">
                    <button class="test-btn" id="run-integration-tests" onclick="runCompleteWorkflowTests()">
                        Run Integration Tests
                    </button>
                    <button class="test-btn secondary" id="show-browser-info" onclick="showBrowserInfo()">
                        Browser Info
                    </button>
                </div>
            </div>
        </section>
    </div>

    <!-- Scripts -->
    <script src="src/js/color-science.js"></script>
    <script src="src/js/pantone-colors.js"></script>
    <script src="src/js/storage.js"></script>
    <script src="src/js/export.js"></script>
    <script src="src/js/calculator.js"></script>
    
    <!-- PWA Service Worker Registration -->
    <script>
        // Register service worker for PWA functionality
        // Requirements: 10.1, 10.2, 10.3, 10.4 - PWA capabilities
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('PWA: Service Worker registered successfully', registration.scope);
                        
                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            console.log('PWA: New service worker found, installing...');
                            
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('PWA: New service worker installed, ready to activate');
                                    showUpdateAvailable();
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('PWA: Service Worker registration failed', error);
                    });
            });
            
            // Listen for service worker messages
            navigator.serviceWorker.addEventListener('message', event => {
                console.log('PWA: Message from service worker', event.data);
            });
            
            // Handle service worker updates
            let refreshing = false;
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                if (!refreshing) {
                    refreshing = true;
                    window.location.reload();
                }
            });
        } else {
            console.log('PWA: Service Worker not supported');
        }
        
        // Show update notification
        function showUpdateAvailable() {
            const updateBanner = document.createElement('div');
            updateBanner.className = 'update-banner';
            updateBanner.innerHTML = `
                <div class="update-content">
                    <span>A new version is available!</span>
                    <button onclick="updateApp()" class="update-btn">Update</button>
                    <button onclick="dismissUpdate()" class="dismiss-btn">Ã—</button>
                </div>
            `;
            document.body.appendChild(updateBanner);
        }
        
        // Update the app
        function updateApp() {
            if (navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ type: 'SKIP_WAITING' });
            }
        }
        
        // Dismiss update notification
        function dismissUpdate() {
            const banner = document.querySelector('.update-banner');
            if (banner) {
                banner.remove();
            }
        }
        
        // Handle install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('PWA: Install prompt available');
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });
        
        // Show install button
        function showInstallButton() {
            const installButton = document.createElement('button');
            installButton.className = 'install-button';
            installButton.textContent = 'Install App';
            installButton.onclick = installApp;
            
            // Add to header or create a floating button
            const header = document.querySelector('.app-header');
            if (header) {
                header.appendChild(installButton);
            }
        }
        
        // Install the app
        async function installApp() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log('PWA: Install prompt outcome:', outcome);
                deferredPrompt = null;
                
                // Hide install button
                const installButton = document.querySelector('.install-button');
                if (installButton) {
                    installButton.remove();
                }
            }
        }
        
        // Handle app installed
        window.addEventListener('appinstalled', (evt) => {
            console.log('PWA: App was installed');
            // Hide install button if still visible
            const installButton = document.querySelector('.install-button');
            if (installButton) {
                installButton.remove();
            }
        });
        
        // Check if running as PWA
        function isPWA() {
            return window.matchMedia('(display-mode: standalone)').matches ||
                   window.navigator.standalone === true;
        }
        
        // Add PWA-specific styling when running as installed app
        if (isPWA()) {
            document.body.classList.add('pwa-mode');
            console.log('PWA: Running as installed app');
        }
        
        // Handle offline/online status
        function updateOnlineStatus() {
            const statusIndicator = document.getElementById('connection-status') || createStatusIndicator();
            
            if (navigator.onLine) {
                statusIndicator.textContent = '';
                statusIndicator.className = 'connection-status online';
            } else {
                statusIndicator.textContent = 'Offline Mode';
                statusIndicator.className = 'connection-status offline';
            }
        }
        
        function createStatusIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'connection-status';
            indicator.className = 'connection-status';
            document.body.appendChild(indicator);
            return indicator;
        }
        
        // Listen for online/offline events
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // Initial status check
        updateOnlineStatus();
    </script>
</body>
</html>