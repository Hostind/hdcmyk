<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HD CMYK • Pro LAB/CMYK Match Studio — Ultra Stable</title>
    <meta name="description" content="Professional HD CMYK color matching with LAB analysis, ICC profiles, heatmap visualization, and industry workflows">
    <meta name="theme-color" content="#1f2937">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="HD CMYK Studio">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="src/assets/icons/icon.svg">
    <link rel="apple-touch-icon" href="src/assets/icons/icon.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #1f2937;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .header-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .header-btn {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .main-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(20px);
            margin-bottom: 30px;
        }

        .color-input-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 40px;
        }

        .color-panel {
            background: #f8fafc;
            border-radius: 15px;
            padding: 30px;
            position: relative;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .color-panel:hover {
            border-color: #3b82f6;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.1);
        }

        .color-panel h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-swatch {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            border: 3px solid #e5e7eb;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            background: #f3f4f6;
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #374151;
        }

        .input-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 15px;
        }

        .input-field {
            display: flex;
            flex-direction: column;
        }

        .input-field label {
            font-size: 12px;
            margin-bottom: 5px;
            color: #6b7280;
        }

        .input-field input {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .input-field input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .calculate-section {
            text-align: center;
            margin: 40px 0;
        }

        .calculate-btn {
            padding: 18px 50px;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(59, 130, 246, 0.3);
        }

        .calculate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(59, 130, 246, 0.4);
        }

        .results-section {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            margin: 30px 0;
        }

        .delta-e-result {
            font-size: 4rem;
            font-weight: 800;
            margin-bottom: 10px;
        }

        .delta-e-label {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .component-deltas {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .delta-component {
            background: rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .delta-component-label {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 5px;
        }

        .delta-component-value {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .advanced-features {
            display: none;
            animation: slideDown 0.5s ease;
        }

        .advanced-features.show {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .feature-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #3b82f6;
        }

        .feature-card h3 {
            margin-bottom: 20px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
        }

        .control-group select,
        .control-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .heatmap-container {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
        }

        .heatmap-canvas {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }

        .status-bar {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px 25px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 100;
        }

        .extended-gamut {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .extended-gamut h4 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .ogv-inputs {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .ogv-inputs .input-field input {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
        }

        .ogv-inputs .input-field input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .tolerance-indicator {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-left: 15px;
        }

        .tolerance-excellent {
            background: #10b981;
            color: white;
        }

        .tolerance-good {
            background: #f59e0b;
            color: white;
        }

        .tolerance-poor {
            background: #ef4444;
            color: white;
        }

        @media (max-width: 768px) {
            .color-input-section {
                grid-template-columns: 1fr;
                gap: 30px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .main-card {
                padding: 25px;
            }

            .delta-e-result {
                font-size: 3rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>HD CMYK • Pro LAB/CMYK Match Studio</h1>
            <p>Ultra Stable • ΔE suite • Patch heatmap • CCM • Substrate simulation • ICC soft proof • CMYKOGV</p>
            <div class="header-controls">
                <button class="header-btn" id="theme-toggle">🌙 Dark Mode</button>
                <button class="header-btn" id="client-profile-btn">👤 Client Profiles</button>
                <button class="header-btn" id="icc-profile-btn">🎨 ICC Profiles</button>
                <button class="header-btn" id="advanced-toggle">🔬 HD Features</button>
            </div>
        </header>

        <div class="main-card">
            <div class="color-input-section">
                <!-- Target Color Panel -->
                <div class="color-panel">
                    <h2>🎯 Target Color</h2>
                    <div class="color-swatch" id="target-swatch"></div>
                    
                    <div class="input-group">
                        <label>CMYK Values (%)</label>
                        <div class="input-row">
                            <div class="input-field">
                                <label>C%</label>
                                <input type="number" id="target-c" placeholder="0" min="0" max="100" step="0.1">
                            </div>
                            <div class="input-field">
                                <label>M%</label>
                                <input type="number" id="target-m" placeholder="0" min="0" max="100" step="0.1">
                            </div>
                            <div class="input-field">
                                <label>Y%</label>
                                <input type="number" id="target-y" placeholder="0" min="0" max="100" step="0.1">
                            </div>
                            <div class="input-field">
                                <label>K%</label>
                                <input type="number" id="target-k" placeholder="0" min="0" max="100" step="0.1">
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>LAB Values</label>
                        <div class="input-row">
                            <div class="input-field">
                                <label>L*</label>
                                <input type="number" id="target-l" placeholder="50" min="0" max="100" step="0.01">
                            </div>
                            <div class="input-field">
                                <label>a*</label>
                                <input type="number" id="target-a" placeholder="0" min="-128" max="127" step="0.01">
                            </div>
                            <div class="input-field">
                                <label>b*</label>
                                <input type="number" id="target-b" placeholder="0" min="-128" max="127" step="0.01">
                            </div>
                        </div>
                    </div>

                    <!-- Extended Gamut for Target -->
                    <div class="extended-gamut" id="target-extended-gamut" style="display: none;">
                        <h4>🌈 Extended Gamut (OGV)</h4>
                        <div class="ogv-inputs">
                            <div class="input-field">
                                <label>O%</label>
                                <input type="number" id="target-o" placeholder="0" min="0" max="100" step="0.1">
                            </div>
                            <div class="input-field">
                                <label>G%</label>
                                <input type="number" id="target-g" placeholder="0" min="0" max="100" step="0.1">
                            </div>
                            <div class="input-field">
                                <label>V%</label>
                                <input type="number" id="target-v" placeholder="0" min="0" max="100" step="0.1">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sample Color Panel -->
                <div class="color-panel">
                    <h2>🔍 Sample Color</h2>
                    <div class="color-swatch" id="sample-swatch"></div>
                    
                    <div class="input-group">
                        <label>CMYK Values (%)</label>
                        <div class="input-row">
                            <div class="input-field">
                                <label>C%</label>
                                <input type="number" id="sample-c" placeholder="0" min="0" max="100" step="0.1">
                            </div>
                            <div class="input-field">
                                <label>M%</label>
                                <input type="number" id="sample-m" placeholder="0" min="0" max="100" step="0.1">
                            </div>
                            <div class="input-field">
                                <label>Y%</label>
                                <input type="number" id="sample-y" placeholder="0" min="0" max="100" step="0.1">
                            </div>
                            <div class="input-field">
                                <label>K%</label>
                                <input type="number" id="sample-k" placeholder="0" min="0" max="100" step="0.1">
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label>LAB Values</label>
                        <div class="input-row">
                            <div class="input-field">
                                <label>L*</label>
                                <input type="number" id="sample-l" placeholder="50" min="0" max="100" step="0.01">
                            </div>
                            <div class="input-field">
                                <label>a*</label>
                                <input type="number" id="sample-a" placeholder="0" min="-128" max="127" step="0.01">
                            </div>
                            <div class="input-field">
                                <label>b*</label>
                                <input type="number" id="sample-b" placeholder="0" min="-128" max="127" step="0.01">
                            </div>
                        </div>
                    </div>

                    <!-- Extended Gamut for Sample -->
                    <div class="extended-gamut" id="sample-extended-gamut" style="display: none;">
                        <h4>🌈 Extended Gamut (OGV)</h4>
                        <div class="ogv-inputs">
                            <div class="input-field">
                                <label>O%</label>
                                <input type="number" id="sample-o" placeholder="0" min="0" max="100" step="0.1">
                            </div>
                            <div class="input-field">
                                <label>G%</label>
                                <input type="number" id="sample-g" placeholder="0" min="0" max="100" step="0.1">
                            </div>
                            <div class="input-field">
                                <label>V%</label>
                                <input type="number" id="sample-v" placeholder="0" min="0" max="100" step="0.1">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="calculate-section">
                <button class="calculate-btn" id="calculate-btn">⚡ Calculate Color Difference</button>
            </div>
        </div>

        <!-- Results Section -->
        <div class="results-section" id="results-section" style="display: none;">
            <div class="delta-e-result" id="delta-e-value">--</div>
            <div class="delta-e-label">ΔE*ab Color Difference<span class="tolerance-indicator" id="tolerance-indicator"></span></div>
            
            <div class="component-deltas">
                <div class="delta-component">
                    <div class="delta-component-label">ΔL*</div>
                    <div class="delta-component-value" id="delta-l">--</div>
                </div>
                <div class="delta-component">
                    <div class="delta-component-label">Δa*</div>
                    <div class="delta-component-value" id="delta-a">--</div>
                </div>
                <div class="delta-component">
                    <div class="delta-component-label">Δb*</div>
                    <div class="delta-component-value" id="delta-b">--</div>
                </div>
                <div class="delta-component">
                    <div class="delta-component-label">ΔC*</div>
                    <div class="delta-component-value" id="delta-c">--</div>
                </div>
                <div class="delta-component">
                    <div class="delta-component-label">Δh</div>
                    <div class="delta-component-value" id="delta-h">--</div>
                </div>
            </div>
        </div>

        <!-- Advanced HD Features -->
        <div class="advanced-features" id="advanced-features">
            <!-- Substrate & Settings -->
            <div class="feature-card">
                <h3>⚙️ HD Analysis Settings</h3>
                <div class="control-grid">
                    <div class="control-group">
                        <label>Substrate Type</label>
                        <select id="substrate-select">
                            <option value="hpw">Hot Press White</option>
                            <option value="inver">Invercote</option>
                            <option value="gsm250">250 gsm</option>
                            <option value="foil">Foil Board</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>Illuminant / Observer</label>
                        <select id="illuminant-select">
                            <option value="D50/2°">D50 / 2°</option>
                            <option value="D50/10°">D50 / 10°</option>
                            <option value="D65/2°">D65 / 2°</option>
                            <option value="D65/10°">D65 / 10°</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>ΔE Tolerance</label>
                        <input id="tolerance-input" type="number" step="0.1" value="2.0" min="0.1" max="10">
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <span style="font-weight: 600;">Total Area Coverage (TAC): </span>
                    <span id="tac-value" style="font-weight: 600; color: #3b82f6;">0%</span>
                </div>
            </div>

            <!-- Heatmap Visualization -->
            <div class="feature-card">
                <h3>🔥 Patch Grid & Heatmap</h3>
                <div class="control-grid">
                    <div class="control-group">
                        <label>Import CSV Data</label>
                        <input type="file" id="csv-import" accept=".csv">
                    </div>
                    <div class="control-group">
                        <label>Grid Size</label>
                        <select id="grid-size">
                            <option value="4x6">4×6 Grid</option>
                            <option value="6x8" selected>6×8 Grid</option>
                            <option value="10x10">10×10 Grid</option>
                        </select>
                    </div>
                </div>
                <div style="margin: 20px 0;">
                    <button class="btn btn-primary" id="generate-grid">✨ Generate Grid</button>
                    <button class="btn btn-secondary" id="clear-grid">🗑️ Clear</button>
                    <button class="btn btn-primary" id="auto-balance">⚙️ Auto-Balance</button>
                </div>
                <div class="heatmap-container">
                    <canvas id="heatmap-canvas" class="heatmap-canvas" width="500" height="300"></canvas>
                    <p style="margin-top: 15px; color: #6b7280; font-style: italic;">
                        Click any cell to edit Target/Press LAB. ΔE00 auto-updates.
                    </p>
                </div>
            </div>

            <!-- Color Correction Matrix -->
            <div class="feature-card">
                <h3>🧮 Color Correction Matrix (CCM)</h3>
                <div class="control-grid">
                    <div class="control-group">
                        <label>Target CSV (L*,a*,b*)</label>
                        <input type="file" id="ccm-target-csv" accept=".csv">
                    </div>
                    <div class="control-group">
                        <label>Press CSV (L*,a*,b*)</label>
                        <input type="file" id="ccm-press-csv" accept=".csv">
                    </div>
                </div>
                <div style="margin: 20px 0;">
                    <button class="btn btn-primary" id="compute-ccm">📊 Compute CCM</button>
                    <button class="btn btn-secondary" id="apply-ccm">→ Apply CCM</button>
                </div>
                <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin-top: 15px;">
                    <pre id="ccm-matrix-output" style="font-family: 'Courier New', monospace; margin: 0;">CCM Matrix: (not computed)</pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Client Profile Modal -->
    <div class="modal" id="client-profile-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>👤 Client Profile & SOP Management</h2>
                <button class="modal-close" id="client-modal-close">×</button>
            </div>
            <div class="modal-body">
                <div class="control-grid">
                    <div class="control-group">
                        <label>Select Profile</label>
                        <select id="client-profile-select">
                            <option value="">Select a profile...</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <button class="btn btn-primary" id="new-profile-btn">➕ New Profile</button>
                    </div>
                </div>
                
                <div id="profile-editor" style="display: none; margin-top: 30px;">
                    <div class="control-grid">
                        <div class="control-group">
                            <label>Profile Name</label>
                            <input type="text" id="profile-name" placeholder="Client Name">
                        </div>
                        <div class="control-group">
                            <label>ΔE Tolerance</label>
                            <input type="number" id="profile-tolerance" step="0.1" value="2.0">
                        </div>
                        <div class="control-group">
                            <label>Contact Email</label>
                            <input type="email" id="profile-contact" placeholder="client@example.com">
                        </div>
                    </div>
                    <div class="control-group">
                        <label>Notes</label>
                        <textarea id="profile-notes" rows="3" placeholder="Client-specific notes..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical;"></textarea>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" id="save-profile">💾 Save Profile</button>
                        <button class="btn btn-secondary" id="cancel-profile-edit">✖ Cancel</button>
                        <button class="btn" id="delete-profile" style="background: #ef4444; color: white; margin-left: auto;">🗑️ Delete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar" id="status-bar">
        <span id="status-text">Ready</span>
    </div>

    <!-- Core Scripts -->
    <script src="src/js/color-science.js"></script>
    <script src="src/js/pantone-colors.js"></script>
    <script src="src/js/storage.js"></script>
    <script src="src/js/export.js"></script>
    
    <!-- HD Color Engine Scripts -->
    <script src="src/js/hd-color-engine.js"></script>
    <script src="src/js/csv-enhanced.js"></script>
    <script src="src/js/heatmap-visualization.js"></script>
    <script src="src/js/client-profiles.js"></script>
    <script src="src/js/icc-profile-manager.js"></script>
    <script src="src/js/hd-integration.js"></script>
    
    <!-- Main Calculator -->
    <script src="src/js/calculator.js"></script>
    
    <!-- ChatGPT-5 UI Integration Script -->
    <script>
        // Enhanced UI Controller for ChatGPT-5 Design
        class HDStudioController {
            constructor() {
                this.state = {
                    hdFeaturesVisible: false,
                    currentTheme: 'light',
                    lastCalculationTime: null
                };
                
                this.init();
            }

            init() {
                console.log('HD CMYK Studio - ChatGPT-5 UI Loading...');
                this.setupEventListeners();
                this.setupColorInputs();
                this.setupRealTimeUpdates();
                this.updateStatus('HD CMYK Studio Ready');
            }

            setupEventListeners() {
                // Header controls
                document.getElementById('advanced-toggle')?.addEventListener('click', () => this.toggleAdvancedFeatures());
                document.getElementById('client-profile-btn')?.addEventListener('click', () => this.showClientProfiles());
                document.getElementById('icc-profile-btn')?.addEventListener('click', () => this.showICCProfiles());
                document.getElementById('theme-toggle')?.addEventListener('click', () => this.toggleTheme());

                // Calculate button
                document.getElementById('calculate-btn')?.addEventListener('click', () => this.performCalculation());

                // Modal controls
                document.getElementById('client-modal-close')?.addEventListener('click', () => this.closeModal('client-profile-modal'));
                document.getElementById('client-profile-modal')?.addEventListener('click', (e) => {
                    if (e.target.id === 'client-profile-modal') this.closeModal('client-profile-modal');
                });

                // HD Feature buttons
                document.getElementById('generate-grid')?.addEventListener('click', () => this.generateGrid());
                document.getElementById('clear-grid')?.addEventListener('click', () => this.clearGrid());
                document.getElementById('auto-balance')?.addEventListener('click', () => this.autoBalance());
                document.getElementById('compute-ccm')?.addEventListener('click', () => this.computeCCM());

                // Profile management
                document.getElementById('new-profile-btn')?.addEventListener('click', () => this.showProfileEditor());
                document.getElementById('save-profile')?.addEventListener('click', () => this.saveProfile());
                document.getElementById('cancel-profile-edit')?.addEventListener('click', () => this.hideProfileEditor());
                document.getElementById('delete-profile')?.addEventListener('click', () => this.deleteProfile());
            }

            setupColorInputs() {
                const colorInputs = [
                    'target-c', 'target-m', 'target-y', 'target-k',
                    'target-l', 'target-a', 'target-b',
                    'sample-c', 'sample-m', 'sample-y', 'sample-k',
                    'sample-l', 'sample-a', 'sample-b',
                    'target-o', 'target-g', 'target-v',
                    'sample-o', 'sample-g', 'sample-v'
                ];

                colorInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.addEventListener('input', this.debounce(() => {
                            this.updateColorSwatch(inputId);
                            this.updateTAC();
                        }, 300));
                    }
                });
            }

            setupRealTimeUpdates() {
                // Update color swatches on load
                this.updateColorSwatch('target-c');
                this.updateColorSwatch('sample-c');
                this.updateTAC();
            }

            toggleAdvancedFeatures() {
                const features = document.getElementById('advanced-features');
                const toggleBtn = document.getElementById('advanced-toggle');
                
                if (features) {
                    this.state.hdFeaturesVisible = !this.state.hdFeaturesVisible;
                    features.classList.toggle('show', this.state.hdFeaturesVisible);
                    
                    // Show/hide extended gamut inputs
                    const extendedGamutSections = document.querySelectorAll('[id*="extended-gamut"]');
                    extendedGamutSections.forEach(section => {
                        section.style.display = this.state.hdFeaturesVisible ? 'block' : 'none';
                    });
                    
                    if (toggleBtn) {
                        toggleBtn.textContent = this.state.hdFeaturesVisible ? '🔬 Hide HD Features' : '🔬 HD Features';
                    }
                    
                    this.updateStatus(this.state.hdFeaturesVisible ? 'HD Features Enabled' : 'HD Features Disabled');
                }
            }

            performCalculation() {
                try {
                    const targetLAB = this.getLABValues('target');
                    const sampleLAB = this.getLABValues('sample');

                    if (!targetLAB || !sampleLAB) {
                        this.updateStatus('Missing LAB values for calculation', 'error');
                        return;
                    }

                    this.updateStatus('Calculating color difference...');

                    // Enhanced Delta E calculation
                    let deltaE = 0;
                    if (window.hdColorEngine) {
                        deltaE = window.hdColorEngine.calculateEnhancedDeltaE(targetLAB, sampleLAB, 'de2000');
                    } else if (window.colorScience) {
                        deltaE = window.colorScience.calculateDeltaE(targetLAB, sampleLAB);
                    } else {
                        deltaE = this.calculateBasicDeltaE(targetLAB, sampleLAB);
                    }

                    // Calculate component deltas
                    const deltaL = sampleLAB.l - targetLAB.l;
                    const deltaA = sampleLAB.a - targetLAB.a;
                    const deltaB = sampleLAB.b - targetLAB.b;
                    const deltaC = Math.sqrt(targetLAB.a * targetLAB.a + targetLAB.b * targetLAB.b) - 
                                   Math.sqrt(sampleLAB.a * sampleLAB.a + sampleLAB.b * sampleLAB.b);
                    const deltaH = Math.sqrt(deltaE * deltaE - deltaL * deltaL - deltaC * deltaC);

                    // Update displays
                    this.updateResults(deltaE, deltaL, deltaA, deltaB, deltaC, deltaH);
                    this.showResults();
                    this.updateStatus(`Calculation complete: ΔE = ${deltaE.toFixed(2)}`);

                    this.state.lastCalculationTime = new Date();

                } catch (error) {
                    console.error('Calculation error:', error);
                    this.updateStatus('Calculation failed', 'error');
                }
            }

            updateResults(deltaE, deltaL, deltaA, deltaB, deltaC, deltaH) {
                // Update main Delta E display
                const deltaEValue = document.getElementById('delta-e-value');
                if (deltaEValue) deltaEValue.textContent = deltaE.toFixed(2);

                // Update component deltas
                const components = { 'delta-l': deltaL, 'delta-a': deltaA, 'delta-b': deltaB, 'delta-c': deltaC, 'delta-h': deltaH };
                Object.entries(components).forEach(([id, value]) => {
                    const element = document.getElementById(id);
                    if (element) element.textContent = value.toFixed(2);
                });

                // Update tolerance indicator
                this.updateToleranceIndicator(deltaE);
            }

            updateToleranceIndicator(deltaE) {
                const indicator = document.getElementById('tolerance-indicator');
                if (!indicator) return;

                let className, text;
                if (deltaE <= 1.0) {
                    className = 'tolerance-excellent';
                    text = 'Excellent';
                } else if (deltaE <= 2.0) {
                    className = 'tolerance-good';
                    text = 'Good';
                } else if (deltaE <= 3.5) {
                    className = 'tolerance-good';
                    text = 'Acceptable';
                } else {
                    className = 'tolerance-poor';
                    text = 'Needs Adjustment';
                }

                indicator.className = `tolerance-indicator ${className}`;
                indicator.textContent = text;
            }

            showResults() {
                const resultsSection = document.getElementById('results-section');
                if (resultsSection) {
                    resultsSection.style.display = 'block';
                    resultsSection.scrollIntoView({ behavior: 'smooth' });
                }
            }

            updateColorSwatch(inputId) {
                const isTarget = inputId.startsWith('target');
                const swatchId = isTarget ? 'target-swatch' : 'sample-swatch';
                
                try {
                    const cmyk = this.getCMYKValues(isTarget ? 'target' : 'sample');
                    const rgb = window.colorScience ? 
                        window.colorScience.cmykToRgb(cmyk.c, cmyk.m, cmyk.y, cmyk.k) : 
                        { r: 128, g: 128, b: 128 };
                    
                    const swatch = document.getElementById(swatchId);
                    if (swatch) {
                        swatch.style.background = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;
                    }
                } catch (error) {
                    console.warn('Error updating color swatch:', error);
                }
            }

            updateTAC() {
                const targetCMYK = this.getCMYKValues('target');
                const sampleCMYK = this.getCMYKValues('sample');
                
                // Add extended gamut values if available
                const targetOGV = this.getOGVValues('target');
                const sampleOGV = this.getOGVValues('sample');
                
                const targetTAC = Object.values(targetCMYK).reduce((sum, val) => sum + val, 0) + 
                                  Object.values(targetOGV).reduce((sum, val) => sum + val, 0);
                const sampleTAC = Object.values(sampleCMYK).reduce((sum, val) => sum + val, 0) + 
                                  Object.values(sampleOGV).reduce((sum, val) => sum + val, 0);
                const maxTAC = Math.max(targetTAC, sampleTAC);
                
                const tacDisplay = document.getElementById('tac-value');
                if (tacDisplay) {
                    tacDisplay.textContent = `${maxTAC.toFixed(1)}%`;
                    tacDisplay.style.color = maxTAC > 320 ? '#ef4444' : '#3b82f6';
                }
            }

            showClientProfiles() {
                this.showModal('client-profile-modal');
                if (window.clientProfiles) {
                    this.populateClientProfiles();
                }
            }

            showICCProfiles() {
                this.updateStatus('ICC Profile management - Feature in development');
            }

            showModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) modal.style.display = 'block';
            }

            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) modal.style.display = 'none';
            }

            populateClientProfiles() {
                if (!window.clientProfiles) return;
                
                const select = document.getElementById('client-profile-select');
                if (select) {
                    const profiles = window.clientProfiles.getAllProfiles();
                    select.innerHTML = '<option value="">Select a profile...</option>';
                    profiles.forEach(profile => {
                        const option = document.createElement('option');
                        option.value = profile.name;
                        option.textContent = profile.name;
                        select.appendChild(option);
                    });
                }
            }

            showProfileEditor() {
                const editor = document.getElementById('profile-editor');
                if (editor) editor.style.display = 'block';
            }

            hideProfileEditor() {
                const editor = document.getElementById('profile-editor');
                if (editor) editor.style.display = 'none';
            }

            saveProfile() {
                // Profile saving logic would go here
                this.updateStatus('Profile saved successfully');
                this.hideProfileEditor();
            }

            deleteProfile() {
                if (confirm('Delete this profile?')) {
                    this.updateStatus('Profile deleted');
                    this.hideProfileEditor();
                }
            }

            generateGrid() {
                this.updateStatus('Generating color grid...');
                // Grid generation logic would integrate with heatmap module
            }

            clearGrid() {
                this.updateStatus('Grid cleared');
                const canvas = document.getElementById('heatmap-canvas');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
            }

            autoBalance() {
                this.updateStatus('Auto-balance in progress...');
                // Auto-balance logic would integrate with HD Color Engine
            }

            computeCCM() {
                this.updateStatus('Computing Color Correction Matrix...');
                const output = document.getElementById('ccm-matrix-output');
                if (output) {
                    output.textContent = 'CCM computation requires paired CSV files';
                }
            }

            toggleTheme() {
                // Theme toggle logic would go here
                this.updateStatus('Theme toggle - Feature in development');
            }

            updateStatus(message, type = 'info') {
                const statusBar = document.getElementById('status-text');
                if (statusBar) {
                    statusBar.textContent = message;
                    
                    // Add visual feedback based on type
                    const statusBarEl = document.getElementById('status-bar');
                    if (statusBarEl) {
                        statusBarEl.style.background = type === 'error' ? '#fef2f2' : 
                                                      type === 'success' ? '#f0fdf4' : 'white';
                        statusBarEl.style.color = type === 'error' ? '#dc2626' : 
                                                  type === 'success' ? '#16a34a' : '#374151';
                    }
                }
                
                console.log(`[HD Studio] ${message}`);
                
                // Auto-clear status after 5 seconds
                setTimeout(() => {
                    if (statusBar && statusBar.textContent === message) {
                        statusBar.textContent = 'Ready';
                        if (statusBarEl) {
                            statusBarEl.style.background = 'white';
                            statusBarEl.style.color = '#374151';
                        }
                    }
                }, 5000);
            }

            // Utility functions
            getLABValues(prefix) {
                const l = parseFloat(document.getElementById(`${prefix}-l`)?.value);
                const a = parseFloat(document.getElementById(`${prefix}-a`)?.value);
                const b = parseFloat(document.getElementById(`${prefix}-b`)?.value);
                
                if (isNaN(l) || isNaN(a) || isNaN(b)) return null;
                return { l, a, b };
            }

            getCMYKValues(prefix) {
                return {
                    c: parseFloat(document.getElementById(`${prefix}-c`)?.value) || 0,
                    m: parseFloat(document.getElementById(`${prefix}-m`)?.value) || 0,
                    y: parseFloat(document.getElementById(`${prefix}-y`)?.value) || 0,
                    k: parseFloat(document.getElementById(`${prefix}-k`)?.value) || 0
                };
            }

            getOGVValues(prefix) {
                return {
                    o: parseFloat(document.getElementById(`${prefix}-o`)?.value) || 0,
                    g: parseFloat(document.getElementById(`${prefix}-g`)?.value) || 0,
                    v: parseFloat(document.getElementById(`${prefix}-v`)?.value) || 0
                };
            }

            calculateBasicDeltaE(lab1, lab2) {
                const deltaL = lab2.l - lab1.l;
                const deltaA = lab2.a - lab1.a;
                const deltaB = lab2.b - lab1.b;
                return Math.sqrt(deltaL * deltaL + deltaA * deltaA + deltaB * deltaB);
            }

            debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        }

        // Initialize the HD Studio Controller when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.hdStudio = new HDStudioController();
        });

        // Fallback initialization if DOM is already loaded
        if (document.readyState !== 'loading') {
            window.hdStudio = new HDStudioController();
        }
    </script>

    <!-- PWA Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('PWA: HD CMYK Studio Service Worker registered', registration.scope);
                    })
                    .catch(error => {
                        console.log('PWA: Service Worker registration failed', error);
                    });
            });
        }
    </script>
</body>
</html>