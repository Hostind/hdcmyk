<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=3.0">
    <title>PWA & Device Testing - Final Validation</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml" href="src/assets/icons/icon.svg">
    <link rel="apple-touch-icon" href="src/assets/icons/icon.svg">
    <link rel="stylesheet" href="src/css/styles.css">
    <meta name="theme-color" content="#007bff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="LAB Calculator">
    <style>
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .test-card {
            padding: 20px;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            background: #ffffff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .test-result {
            margin: 5px 0;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .pass { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .fail { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .warn { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        .info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        .device-info {
            background: var(--gold-accent-bg);
            border: 1px solid var(--gold-accent-border);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .feature-matrix {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
            font-size: 0.9rem;
        }
        .feature-matrix > div {
            padding: 8px;
            border: 1px solid #dee2e6;
            background: #f8f9fa;
            text-align: center;
        }
        .feature-matrix > div:first-child {
            text-align: left;
            font-weight: 600;
        }
        .matrix-header {
            background: var(--gold-primary) !important;
            color: white;
            font-weight: 600;
        }
        .support-yes { background: #d4edda !important; color: #155724; }
        .support-no { background: #f8d7da !important; color: #721c24; }
        .support-partial { background: #fff3cd !important; color: #856404; }
    </style>
</head>
<body>
    <!-- Enhanced Status Bar for Testing -->
    <div class="status-bar visible" id="status-bar" role="banner" aria-label="Calculator status and quick actions">
        <div class="status-bar-content">
            <div class="status-info">
                <span class="status-label">Status:</span>
                <span class="status-value" id="status-value">PWA Testing</span>
            </div>
            <div class="delta-info">
                <span class="delta-label">Device:</span>
                <span class="delta-value" id="device-type">Detecting...</span>
            </div>
            <div class="quick-actions-bar">
                <button class="status-action-btn" onclick="runPWATests()">PWA Test</button>
                <button class="status-action-btn" onclick="runDeviceTests()">Device Test</button>
                <button class="status-action-btn" onclick="runAllFinalTests()">All Tests</button>
            </div>
        </div>
    </div>

    <div class="calculator-container" style="margin-top: 80px;">
        <header class="app-header">
            <h1>PWA & Device Final Validation</h1>
            <p class="subtitle">Comprehensive testing of PWA functionality and cross-device compatibility</p>
        </header>

        <!-- Device Information -->
        <div class="device-info" id="device-info">
            <h3>üîç Device Detection</h3>
            <div id="device-details">Analyzing device capabilities...</div>
        </div>

        <!-- Test Grid -->
        <div class="test-grid">
            <!-- PWA Core Features -->
            <div class="test-card">
                <h3>üì± PWA Core Features</h3>
                <div id="pwa-results"></div>
                <button onclick="runPWATests()" class="btn-outlined gold">Test PWA</button>
            </div>

            <!-- Service Worker -->
            <div class="test-card">
                <h3>‚öôÔ∏è Service Worker</h3>
                <div id="sw-results"></div>
                <button onclick="testServiceWorker()" class="btn-outlined gold">Test SW</button>
            </div>

            <!-- Responsive Design -->
            <div class="test-card">
                <h3>üìê Responsive Design</h3>
                <div id="responsive-results"></div>
                <button onclick="testResponsiveDesign()" class="btn-outlined gold">Test Responsive</button>
            </div>

            <!-- Touch & Input -->
            <div class="test-card">
                <h3>üëÜ Touch & Input</h3>
                <div id="touch-results"></div>
                <button onclick="testTouchInput()" class="btn-outlined gold">Test Touch</button>
            </div>

            <!-- Performance -->
            <div class="test-card">
                <h3>‚ö° Performance</h3>
                <div id="performance-results"></div>
                <button onclick="testPerformance()" class="btn-outlined gold">Test Performance</button>
            </div>

            <!-- Accessibility -->
            <div class="test-card">
                <h3>‚ôø Accessibility</h3>
                <div id="a11y-results"></div>
                <button onclick="testAccessibility()" class="btn-outlined gold">Test A11y</button>
            </div>
        </div>

        <!-- Browser Support Matrix -->
        <div class="test-card">
            <h3>üåê Browser Support Matrix</h3>
            <div class="feature-matrix" id="browser-matrix">
                <div class="matrix-header">Feature</div>
                <div class="matrix-header">Support</div>
                <div class="matrix-header">Status</div>
            </div>
            <button onclick="generateBrowserMatrix()" class="btn-outlined gold-premium">Generate Matrix</button>
        </div>

        <!-- Calculator Integration Test -->
        <div class="test-card">
            <h3>üßÆ Calculator Integration</h3>
            <section class="color-section" style="margin-top: 15px;">
                <h4 class="tooltip-enhanced" data-tooltip="Testing enhanced tooltips on mobile devices" tabindex="0">
                    Mobile Calculator Test
                </h4>
                <div class="color-display">
                    <div class="color-swatch" id="test-swatch" style="background: linear-gradient(45deg, #ff6b6b, #4ecdc4);"></div>
                </div>
                <div class="input-groups">
                    <div class="input-group">
                        <label class="group-label">Test CMYK Values</label>
                        <div class="input-row">
                            <div class="input-field">
                                <label for="test-c">C%</label>
                                <input type="number" id="test-c" value="25" min="0" max="100" step="0.1">
                            </div>
                            <div class="input-field">
                                <label for="test-m">M%</label>
                                <input type="number" id="test-m" value="50" min="0" max="100" step="0.1">
                            </div>
                        </div>
                    </div>
                </div>
                <button class="calculate-button btn-outlined gold-premium" onclick="testCalculatorFunction()">
                    Test Calculate
                </button>
            </section>
        </div>

        <!-- Final Summary -->
        <div class="test-card" style="grid-column: 1 / -1;">
            <h3>üìä Final Test Summary</h3>
            <div id="final-summary"></div>
            <button onclick="runAllFinalTests()" class="btn-outlined gold-premium" style="width: 100%; margin-top: 15px;">
                Run Complete Test Suite
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="src/js/color-science.js"></script>
    <script src="src/js/pantone-colors.js"></script>
    <script src="test-cross-browser-ui-enhancements.js"></script>

    <script>
        // Final Testing Suite
        let allTestResults = [];
        let deviceInfo = {};

        function addTestResult(category, test, passed, message, details = '') {
            allTestResults.push({
                category,
                test,
                passed,
                message,
                details,
                timestamp: new Date()
            });
        }

        function displayResult(containerId, test, passed, message, details = '') {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${passed ? 'pass' : 'fail'}`;
            
            let icon = passed ? '‚úÖ' : '‚ùå';
            let content = `<strong>${icon} ${test}:</strong> ${message}`;
            if (details) content += `<br><small>${details}</small>`;
            
            resultDiv.innerHTML = content;
            container.appendChild(resultDiv);
        }

        function displayInfo(containerId, message) {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result info';
            resultDiv.innerHTML = `<strong>‚ÑπÔ∏è Info:</strong> ${message}`;
            container.appendChild(resultDiv);
        }

        function displayWarning(containerId, message) {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result warn';
            resultDiv.innerHTML = `<strong>‚ö†Ô∏è Warning:</strong> ${message}`;
            container.appendChild(resultDiv);
        }

        // Device Detection
        function detectDevice() {
            const ua = navigator.userAgent;
            const platform = navigator.platform;
            const maxTouchPoints = navigator.maxTouchPoints;
            
            deviceInfo = {
                userAgent: ua,
                platform: platform,
                isMobile: /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua),
                isTablet: /iPad|Android(?!.*Mobile)/i.test(ua),
                isIOS: /iPad|iPhone|iPod/.test(ua),
                isAndroid: /Android/i.test(ua),
                isWindows: /Windows/i.test(ua),
                isMac: /Mac/i.test(ua),
                touchSupport: maxTouchPoints > 0 || 'ontouchstart' in window,
                maxTouchPoints: maxTouchPoints,
                screenSize: { width: screen.width, height: screen.height },
                viewportSize: { width: window.innerWidth, height: window.innerHeight },
                pixelRatio: window.devicePixelRatio,
                orientation: screen.orientation ? screen.orientation.type : 'unknown',
                connection: navigator.connection ? {
                    effectiveType: navigator.connection.effectiveType,
                    downlink: navigator.connection.downlink,
                    rtt: navigator.connection.rtt
                } : null
            };

            // Update status bar
            let deviceType = deviceInfo.isMobile ? 'Mobile' : deviceInfo.isTablet ? 'Tablet' : 'Desktop';
            document.getElementById('device-type').textContent = deviceType;

            // Display device details
            const detailsHtml = `
                <strong>Device Type:</strong> ${deviceType}<br>
                <strong>Platform:</strong> ${deviceInfo.platform}<br>
                <strong>Screen:</strong> ${deviceInfo.screenSize.width}√ó${deviceInfo.screenSize.height} (${deviceInfo.pixelRatio}x)<br>
                <strong>Viewport:</strong> ${deviceInfo.viewportSize.width}√ó${deviceInfo.viewportSize.height}<br>
                <strong>Touch:</strong> ${deviceInfo.touchSupport ? `Yes (${deviceInfo.maxTouchPoints} points)` : 'No'}<br>
                <strong>Orientation:</strong> ${deviceInfo.orientation}<br>
                ${deviceInfo.connection ? `<strong>Connection:</strong> ${deviceInfo.connection.effectiveType} (${deviceInfo.connection.downlink}Mbps)<br>` : ''}
            `;
            document.getElementById('device-details').innerHTML = detailsHtml;
        }

        // PWA Tests
        async function runPWATests() {
            const container = document.getElementById('pwa-results');
            container.innerHTML = '';

            displayInfo('pwa-results', 'Testing PWA core features...');

            // Test Manifest
            const manifestLink = document.querySelector('link[rel="manifest"]');
            const hasManifest = !!manifestLink;
            displayResult('pwa-results', 'Web App Manifest', hasManifest, 
                hasManifest ? `Manifest linked: ${manifestLink.href}` : 'No manifest link found');
            addTestResult('PWA', 'Manifest', hasManifest, 'Web app manifest availability');

            // Test Service Worker
            const hasSW = 'serviceWorker' in navigator;
            displayResult('pwa-results', 'Service Worker API', hasSW, 
                hasSW ? 'Service Worker API available' : 'Service Worker not supported');
            addTestResult('PWA', 'Service Worker API', hasSW, 'Service Worker API support');

            if (hasSW) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    const isRegistered = !!registration;
                    displayResult('pwa-results', 'SW Registration', isRegistered, 
                        isRegistered ? 'Service Worker registered' : 'Service Worker not registered');
                    addTestResult('PWA', 'SW Registration', isRegistered, 'Service Worker registration status');
                } catch (error) {
                    displayResult('pwa-results', 'SW Registration', false, `Registration check failed: ${error.message}`);
                    addTestResult('PWA', 'SW Registration', false, 'Service Worker registration check failed');
                }
            }

            // Test Storage APIs
            const hasLocalStorage = typeof Storage !== 'undefined';
            displayResult('pwa-results', 'Local Storage', hasLocalStorage, 
                hasLocalStorage ? 'Local Storage available' : 'Local Storage not supported');
            addTestResult('PWA', 'Local Storage', hasLocalStorage, 'Local Storage API support');

            // Test App Install Prompt
            let installPromptSupported = false;
            window.addEventListener('beforeinstallprompt', () => {
                installPromptSupported = true;
            });
            
            setTimeout(() => {
                displayResult('pwa-results', 'Install Prompt', installPromptSupported, 
                    installPromptSupported ? 'Install prompt available' : 'Install prompt not triggered');
                addTestResult('PWA', 'Install Prompt', installPromptSupported, 'App install prompt support');
            }, 1000);

            // Test Offline Detection
            const onlineStatus = navigator.onLine;
            displayResult('pwa-results', 'Network Status', true, 
                `Currently ${onlineStatus ? 'online' : 'offline'}`);
            addTestResult('PWA', 'Network Status', true, 'Network status detection');
        }

        // Service Worker Tests
        async function testServiceWorker() {
            const container = document.getElementById('sw-results');
            container.innerHTML = '';

            displayInfo('sw-results', 'Testing Service Worker functionality...');

            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.getRegistration();
                    
                    if (registration) {
                        displayResult('sw-results', 'SW Active', true, 'Service Worker is active');
                        
                        const scope = registration.scope;
                        displayResult('sw-results', 'SW Scope', true, `Scope: ${scope}`);
                        
                        const state = registration.active ? registration.active.state : 'unknown';
                        displayResult('sw-results', 'SW State', state === 'activated', `State: ${state}`);
                        
                        // Test SW messaging
                        if (registration.active) {
                            registration.active.postMessage({ type: 'TEST_MESSAGE' });
                            displayResult('sw-results', 'SW Messaging', true, 'Test message sent to SW');
                        }
                        
                    } else {
                        displayResult('sw-results', 'SW Registration', false, 'No Service Worker registered');
                    }
                } catch (error) {
                    displayResult('sw-results', 'SW Error', false, `Error: ${error.message}`);
                }
            } else {
                displayResult('sw-results', 'SW Support', false, 'Service Worker not supported');
            }

            addTestResult('Service Worker', 'Functionality', true, 'Service Worker tests completed');
        }

        // Responsive Design Tests
        function testResponsiveDesign() {
            const container = document.getElementById('responsive-results');
            container.innerHTML = '';

            displayInfo('responsive-results', 'Testing responsive design...');

            // Test viewport meta tag
            const viewport = document.querySelector('meta[name="viewport"]');
            const hasViewport = !!viewport;
            displayResult('responsive-results', 'Viewport Meta', hasViewport, 
                hasViewport ? `Content: ${viewport.content}` : 'Viewport meta tag missing');

            // Test CSS media queries
            const breakpoints = [
                { name: 'Mobile', query: '(max-width: 768px)' },
                { name: 'Tablet', query: '(min-width: 769px) and (max-width: 1024px)' },
                { name: 'Desktop', query: '(min-width: 1025px)' }
            ];

            let activeBreakpoint = 'unknown';
            breakpoints.forEach(bp => {
                const matches = window.matchMedia(bp.query).matches;
                if (matches) activeBreakpoint = bp.name;
                displayResult('responsive-results', `${bp.name} Breakpoint`, true, 
                    `${bp.name}: ${matches ? 'active' : 'inactive'}`);
            });

            // Test flexible grid
            const calculatorMain = document.querySelector('.calculator-main');
            if (calculatorMain) {
                const style = getComputedStyle(calculatorMain);
                const display = style.display;
                displayResult('responsive-results', 'Grid Layout', display === 'grid', 
                    `Display: ${display}`);
            }

            // Test status bar responsiveness
            const statusBar = document.getElementById('status-bar');
            if (statusBar) {
                const style = getComputedStyle(statusBar);
                const position = style.position;
                displayResult('responsive-results', 'Status Bar Layout', position === 'fixed', 
                    `Position: ${position}`);
            }

            addTestResult('Responsive', 'Design Tests', true, `Active breakpoint: ${activeBreakpoint}`);
        }

        // Touch & Input Tests
        function testTouchInput() {
            const container = document.getElementById('touch-results');
            container.innerHTML = '';

            displayInfo('touch-results', 'Testing touch and input capabilities...');

            // Test touch events
            const hasTouchEvents = 'ontouchstart' in window;
            displayResult('touch-results', 'Touch Events', hasTouchEvents, 
                hasTouchEvents ? 'Touch events supported' : 'Touch events not supported');

            // Test pointer events
            const hasPointerEvents = 'onpointerdown' in window;
            displayResult('touch-results', 'Pointer Events', hasPointerEvents, 
                hasPointerEvents ? 'Pointer events supported' : 'Pointer events not supported');

            // Test max touch points
            const maxTouchPoints = navigator.maxTouchPoints || 0;
            displayResult('touch-results', 'Multi-touch', maxTouchPoints > 1, 
                `Max touch points: ${maxTouchPoints}`);

            // Test input types
            const inputTypes = ['number', 'tel', 'email', 'color'];
            inputTypes.forEach(type => {
                const input = document.createElement('input');
                input.type = type;
                const supported = input.type === type;
                displayResult('touch-results', `Input Type: ${type}`, supported, 
                    supported ? 'Supported' : 'Fallback to text');
            });

            // Test button sizes for touch
            const buttons = document.querySelectorAll('button');
            let touchFriendlyButtons = 0;
            buttons.forEach(button => {
                const rect = button.getBoundingClientRect();
                if (rect.height >= 44) touchFriendlyButtons++; // 44px is minimum touch target
            });
            
            const touchFriendlyRatio = buttons.length > 0 ? (touchFriendlyButtons / buttons.length) : 0;
            displayResult('touch-results', 'Touch-Friendly Buttons', touchFriendlyRatio > 0.8, 
                `${touchFriendlyButtons}/${buttons.length} buttons are touch-friendly`);

            addTestResult('Touch', 'Input Tests', true, 'Touch and input tests completed');
        }

        // Performance Tests
        async function testPerformance() {
            const container = document.getElementById('performance-results');
            container.innerHTML = '';

            displayInfo('performance-results', 'Testing performance metrics...');

            // Test load time
            if (performance.timing) {
                const timing = performance.timing;
                const loadTime = timing.loadEventEnd - timing.navigationStart;
                const domReady = timing.domContentLoadedEventEnd - timing.navigationStart;
                
                displayResult('performance-results', 'Page Load Time', loadTime < 5000, 
                    `${loadTime}ms (target: <5000ms)`);
                displayResult('performance-results', 'DOM Ready Time', domReady < 2000, 
                    `${domReady}ms (target: <2000ms)`);
            }

            // Test memory usage
            if (performance.memory) {
                const memory = performance.memory;
                const usedMemory = Math.round(memory.usedJSHeapSize / 1024 / 1024);
                displayResult('performance-results', 'Memory Usage', usedMemory < 50, 
                    `${usedMemory}MB (target: <50MB)`);
            } else {
                displayWarning('performance-results', 'Memory API not available');
            }

            // Test animation performance
            let frameCount = 0;
            let fps = 0;
            const start = performance.now();
            
            function countFrames() {
                frameCount++;
                const elapsed = performance.now() - start;
                
                if (elapsed < 1000) {
                    requestAnimationFrame(countFrames);
                } else {
                    fps = Math.round(frameCount);
                    displayResult('performance-results', 'Animation FPS', fps > 30, 
                        `${fps} FPS (target: >30)`);
                }
            }
            
            if (typeof requestAnimationFrame === 'function') {
                requestAnimationFrame(countFrames);
            }

            // Test CSS feature support
            const criticalFeatures = [
                'CSS Grid', 'CSS Flexbox', 'CSS Custom Properties', 
                'CSS Transforms', 'CSS Transitions'
            ];
            
            let supportedFeatures = 0;
            criticalFeatures.forEach(feature => {
                let supported = false;
                switch(feature) {
                    case 'CSS Grid':
                        supported = CSS.supports('display', 'grid');
                        break;
                    case 'CSS Flexbox':
                        supported = CSS.supports('display', 'flex');
                        break;
                    case 'CSS Custom Properties':
                        supported = CSS.supports('color', 'var(--test)');
                        break;
                    case 'CSS Transforms':
                        supported = CSS.supports('transform', 'translateY(0)');
                        break;
                    case 'CSS Transitions':
                        supported = CSS.supports('transition', 'all 0.3s ease');
                        break;
                }
                if (supported) supportedFeatures++;
            });
            
            displayResult('performance-results', 'CSS Feature Support', supportedFeatures === criticalFeatures.length, 
                `${supportedFeatures}/${criticalFeatures.length} critical features supported`);

            addTestResult('Performance', 'Metrics', true, 'Performance tests completed');
        }

        // Accessibility Tests
        function testAccessibility() {
            const container = document.getElementById('a11y-results');
            container.innerHTML = '';

            displayInfo('a11y-results', 'Testing accessibility features...');

            // Test semantic HTML
            const semanticElements = document.querySelectorAll('main, section, header, nav, article, aside, footer, h1, h2, h3, h4, h5, h6');
            displayResult('a11y-results', 'Semantic HTML', semanticElements.length > 0, 
                `${semanticElements.length} semantic elements found`);

            // Test ARIA labels
            const ariaLabels = document.querySelectorAll('[aria-label]');
            displayResult('a11y-results', 'ARIA Labels', ariaLabels.length > 0, 
                `${ariaLabels.length} elements with ARIA labels`);

            // Test keyboard navigation
            const focusableElements = document.querySelectorAll('button, input, select, a, [tabindex]:not([tabindex="-1"])');
            displayResult('a11y-results', 'Keyboard Navigation', focusableElements.length > 0, 
                `${focusableElements.length} focusable elements`);

            // Test color contrast (basic check)
            const buttons = document.querySelectorAll('button');
            let contrastIssues = 0;
            buttons.forEach(button => {
                const style = getComputedStyle(button);
                const bgColor = style.backgroundColor;
                const color = style.color;
                
                // Simple check for white text on white background or black text on black background
                if ((color === 'rgb(255, 255, 255)' && bgColor === 'rgb(255, 255, 255)') ||
                    (color === 'rgb(0, 0, 0)' && bgColor === 'rgb(0, 0, 0)')) {
                    contrastIssues++;
                }
            });
            
            displayResult('a11y-results', 'Color Contrast', contrastIssues === 0, 
                contrastIssues > 0 ? `${contrastIssues} potential contrast issues` : 'No obvious contrast issues');

            // Test skip links
            const skipLinks = document.querySelectorAll('.skip-link');
            displayResult('a11y-results', 'Skip Links', skipLinks.length > 0, 
                skipLinks.length > 0 ? `${skipLinks.length} skip links found` : 'No skip links found');

            // Test lang attribute
            const hasLang = document.documentElement.hasAttribute('lang');
            displayResult('a11y-results', 'Language Declaration', hasLang, 
                hasLang ? `Language: ${document.documentElement.lang}` : 'No lang attribute');

            addTestResult('Accessibility', 'Features', true, 'Accessibility tests completed');
        }

        // Browser Support Matrix
        function generateBrowserMatrix() {
            const container = document.getElementById('browser-matrix');
            
            // Clear existing content except headers
            const headers = container.querySelectorAll('.matrix-header');
            container.innerHTML = '';
            headers.forEach(header => container.appendChild(header));

            const features = [
                { name: 'Service Worker', test: () => 'serviceWorker' in navigator },
                { name: 'CSS Grid', test: () => CSS.supports('display', 'grid') },
                { name: 'CSS Flexbox', test: () => CSS.supports('display', 'flex') },
                { name: 'CSS Custom Properties', test: () => CSS.supports('color', 'var(--test)') },
                { name: 'Fetch API', test: () => typeof fetch === 'function' },
                { name: 'Promise', test: () => typeof Promise === 'function' },
                { name: 'Local Storage', test: () => typeof localStorage !== 'undefined' },
                { name: 'Touch Events', test: () => 'ontouchstart' in window },
                { name: 'Pointer Events', test: () => 'onpointerdown' in window },
                { name: 'Web App Manifest', test: () => !!document.querySelector('link[rel="manifest"]') },
                { name: 'Backdrop Filter', test: () => CSS.supports('backdrop-filter', 'blur(10px)') },
                { name: 'Intersection Observer', test: () => typeof IntersectionObserver === 'function' },
                { name: 'Resize Observer', test: () => typeof ResizeObserver === 'function' },
                { name: 'Clipboard API', test: () => navigator.clipboard !== undefined }
            ];

            features.forEach(feature => {
                const supported = feature.test();
                
                const nameDiv = document.createElement('div');
                nameDiv.textContent = feature.name;
                container.appendChild(nameDiv);
                
                const statusDiv = document.createElement('div');
                statusDiv.textContent = supported ? 'Yes' : 'No';
                statusDiv.className = supported ? 'support-yes' : 'support-no';
                container.appendChild(statusDiv);
                
                const detailDiv = document.createElement('div');
                detailDiv.textContent = supported ? '‚úÖ' : '‚ùå';
                detailDiv.className = supported ? 'support-yes' : 'support-no';
                container.appendChild(detailDiv);

                addTestResult('Browser Support', feature.name, supported, `${feature.name} support`);
            });
        }

        // Calculator Function Test
        function testCalculatorFunction() {
            displayInfo('final-summary', 'Testing calculator integration with UI enhancements...');
            
            // Mock calculation
            const cValue = document.getElementById('test-c').value;
            const mValue = document.getElementById('test-m').value;
            
            // Update test swatch
            const testSwatch = document.getElementById('test-swatch');
            testSwatch.style.background = `linear-gradient(45deg, 
                hsl(${360 - cValue * 3.6}, ${100 - mValue}%, 50%), 
                hsl(${cValue * 3.6}, ${mValue}%, 70%))`;
            
            displayResult('final-summary', 'Calculator Integration', true, 
                `Mock calculation completed with C:${cValue}%, M:${mValue}%`);
            
            addTestResult('Calculator', 'Integration', true, 'Calculator function integration test');
        }

        // Run All Final Tests
        async function runAllFinalTests() {
            // Clear all results
            ['pwa-results', 'sw-results', 'responsive-results', 'touch-results', 
             'performance-results', 'a11y-results', 'final-summary'].forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
            
            allTestResults = [];
            
            displayInfo('final-summary', 'Starting comprehensive final test suite...');
            
            // Run all tests
            await runPWATests();
            await testServiceWorker();
            testResponsiveDesign();
            testTouchInput();
            await testPerformance();
            testAccessibility();
            generateBrowserMatrix();
            testCalculatorFunction();
            
            // Generate final summary
            setTimeout(() => {
                generateFinalSummary();
            }, 2000);
        }

        // Generate Final Summary
        function generateFinalSummary() {
            const container = document.getElementById('final-summary');
            
            const categories = ['PWA', 'Service Worker', 'Responsive', 'Touch', 'Performance', 'Accessibility', 'Browser Support', 'Calculator'];
            let categoryResults = {};
            
            categories.forEach(cat => {
                const catResults = allTestResults.filter(r => r.category === cat);
                const passed = catResults.filter(r => r.passed).length;
                const total = catResults.length;
                const percentage = total > 0 ? Math.round((passed / total) * 100) : 100;
                
                categoryResults[cat] = { passed, total, percentage };
            });
            
            const overallPassed = allTestResults.filter(r => r.passed).length;
            const overallTotal = allTestResults.length;
            const overallPercentage = overallTotal > 0 ? Math.round((overallPassed / overallTotal) * 100) : 100;
            
            let summaryHTML = `
                <div class="test-result ${overallPercentage >= 90 ? 'pass' : overallPercentage >= 70 ? 'warn' : 'fail'}">
                    <strong>üéØ Final Test Summary</strong><br>
                    <strong>Overall Score: ${overallPercentage}% (${overallPassed}/${overallTotal} tests passed)</strong><br>
                    <strong>Device:</strong> ${deviceInfo.isMobile ? 'Mobile' : deviceInfo.isTablet ? 'Tablet' : 'Desktop'} - ${deviceInfo.platform}<br>
                    <strong>Viewport:</strong> ${deviceInfo.viewportSize.width}√ó${deviceInfo.viewportSize.height}<br>
                    <strong>Status:</strong> ${overallPercentage >= 90 ? 'Production Ready ‚úÖ' : overallPercentage >= 70 ? 'Minor Issues ‚ö†Ô∏è' : 'Needs Attention ‚ùå'}
                </div>
            `;
            
            Object.entries(categoryResults).forEach(([category, result]) => {
                const status = result.percentage >= 90 ? 'pass' : result.percentage >= 70 ? 'warn' : 'fail';
                summaryHTML += `
                    <div class="test-result ${status}">
                        <strong>${category}:</strong> ${result.percentage}% (${result.passed}/${result.total})
                    </div>
                `;
            });
            
            summaryHTML += `
                <div class="test-result info">
                    <strong>Timestamp:</strong> ${new Date().toLocaleString()}<br>
                    <strong>User Agent:</strong> ${navigator.userAgent.substring(0, 100)}...
                </div>
            `;
            
            container.innerHTML = summaryHTML;
            
            console.log('Final PWA & Device Test Results:', {
                overallScore: overallPercentage,
                categoryResults,
                deviceInfo,
                allResults: allTestResults
            });
        }

        // Initialize
        window.addEventListener('load', () => {
            detectDevice();
            
            // Auto-run tests after a delay
            setTimeout(() => {
                runAllFinalTests();
            }, 1500);
        });

        // Handle orientation changes
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                detectDevice();
                displayInfo('final-summary', 'Device orientation changed - updating tests...');
            }, 500);
        });

        // Handle resize events
        window.addEventListener('resize', () => {
            deviceInfo.viewportSize = { width: window.innerWidth, height: window.innerHeight };
            document.getElementById('device-type').textContent = 
                deviceInfo.isMobile ? 'Mobile' : deviceInfo.isTablet ? 'Tablet' : 'Desktop';
        });
    </script>
</body>
</html>